# 解决"符号+中文"混合输出问题

## 问题描述

模型输出了类似 `∇秩序`、`♡情绪`、`△群体` 这样的"符号+中文"混合格式，而不是纯粹的Novlang符号语言。

### 错误示例（来自rounds.json）
```
"伊莎贝拉 · ↔ · 玛丽亚 · ： ∇秩序 2024-02-14 ♡情绪 派对"
"△群体 ↔ 互动 ♡情绪"
```

## 根本原因

提示词中使用了错误的示例格式：

**旧版提示词（错误）：**
```
【20个基础符号】
●存在  —过程  ｜界限  △群体  □范围  ∟转折...
```

模型看到这种格式，就学会了在符号后面直接附加中文含义。

## 解决方案

### 1. 修改 `generate_chat.txt`

**已修改的关键部分：**

```
【错误示例】
❌ ∇秩序（不要在符号后面直接跟中文）
❌ ♡情绪 派对（不要混用符号和中文词汇）
❌ 伊莎贝拉 ↔互动 玛丽亚（不要在符号旁边写含义）

【正确示例】
✓ ∇ (表示秩序)
✓ ●·↔·△：霍布斯咖啡馆 (人物在咖啡馆互动)
✓ ♡·⊗·△·→·⊕ (情绪融合群体带来能量)
```

### 2. 创建清晰的规则文件

创建了 `novlang_rules_clean.txt`，使用表格格式清晰展示：

```
| 符号 | 含义 |
|-----|------|
| ● | 存在/实体 |
| ∇ | 秩序/层级 |
```

这样模型能理解符号含义，但不会在输出时混用。

### 3. 强调分离原则

在提示词开头添加醒目提示：

```
❗❗❗ 重要：符号和中文分离原则 ❗❗❗
- 在实际对话中，只能输出符号，不能在符号后面直接附加中文含义
- 中文只能出现在"："之后作为专有名词锚点
```

### 4. 修改JSON输出格式

**旧格式：**
```json
{
    "伊莎贝拉": "<说的话>",
    "translation": "<翻译>"
}
```

**新格式：**
```json
{
    "text": "<纯符号Novlang，不要在符号后面跟中文>",
    "translation": "<中文翻译>"
}
```

## 如何使用新配置

### 方式1: 使用清理版规则（推荐）

```powershell
python party_chat.py `
  --name clean-test `
  --rounds 50 `
  --novlang-file data\prompts\novlang_rules_clean.txt
```

### 方式2: 已有实验继续（会应用新提示词）

由于 `generate_chat.txt` 已修改，新的对话会使用更新的规则：

```powershell
python party_chat.py `
  --name my-test `
  --rounds 50 `
  --resume `
  --novlang-file data\prompts\novlang_rules_clean.txt
```

## 验证效果

### 正确的输出应该是：

```json
{
  "round": 21,
  "speaker": "伊莎贝拉",
  "content": "∅·●·↔·△·♡：派对",
  "translation": "我想邀请大家参加派对"
}
```

### 不应该出现：

```json
{
  "content": "∇秩序 ♡情绪 △群体互动"  // ❌ 错误
}
```

## 对比

| 方面 | 修改前 | 修改后 |
|------|--------|--------|
| 符号展示 | `●存在 —过程` | `● = 存在` 或表格 |
| 示例格式 | 无明确错误示例 | 列出错误和正确示例 |
| 输出要求 | 模糊 | 明确"纯符号，不跟中文" |
| JSON字段 | 用agent名作key | 用"text"作key |

## 预期改进

### 短期效果（1-5轮）
- 减少"符号+中文"混合输出
- 符号使用更纯粹
- 仍可能偶尔混用（需要模型学习）

### 中期效果（5-20轮）
- 基本消除混合输出
- 符号组合更规范
- 只在":"后使用中文

### 长期效果（20+轮）
- 完全使用纯符号
- 复杂表达更流畅
- 形成稳定的符号语法

## 额外建议

### 1. 如果问题持续

修改LLM的temperature参数（如果支持）：

```json
{
  "think": {
    "llm": {
      "temperature": 0.3  // 降低随机性
    }
  }
}
```

### 2. 手动清理数据

可以用脚本清理已有的rounds.json：

```python
import re

def clean_novlang(text):
    """移除符号后面的中文"""
    # 匹配符号后面的中文
    pattern = r'([●—｜△□∟⌒✧↔⊃≠≈○╬♡∝⊕∅∞∇])([一-龥]+)'
    return re.sub(pattern, r'\1', text)
```

### 3. Few-shot示例

在提示词中添加更多正确示例：

```
最近的正确对话示例：
A: ∅·●·↔·△·♡
B: ✓·●·⊃·△·：咖啡馆
A: ！·(♡⊗△)·—·∇·：17:00
```

## 总结

**问题根源：** 提示词中使用了 `●存在` 这样的格式作为示例

**解决方法：** 
1. ✅ 修改 `generate_chat.txt` - 添加错误示例警告
2. ✅ 创建 `novlang_rules_clean.txt` - 使用表格展示
3. ✅ 强调分离原则 - 在提示词开头显眼位置
4. ✅ 修改JSON格式 - 使用"text"字段并明确要求

**使用方法：**
```powershell
# 新实验使用清理版规则
python party_chat.py --name test-clean --rounds 50 --novlang-file data\prompts\novlang_rules_clean.txt

# 旧实验也会受益（因为generate_chat.txt已更新）
python party_chat.py --name my-test --resume --rounds 50 --novlang-file data\prompts\novlang_rules_clean.txt
```

---

**重要提示：** 如果你已经运行了一些轮次，新的对话会使用更新的提示词，所以会逐渐改善。建议开启新实验来验证效果。
