# 增加对话频率优化方案

## 问题诊断

### 当前状况
- **运行时长**：20步 × 10分钟 = 3小时10分钟模拟时间
- **对话次数**：仅2次
- **对话频率**：平均1.5小时1次 ❌ **太低了！**

### 根本原因
虽然我们已经将对话间隔从60分钟降到15分钟，但agents很少相遇：

```
09:30-12:40 的位置分布：
- 伊莎贝拉：霍布斯咖啡馆（74, 23）
- 玛丽亚：奥克山学院宿舍，自己房间（123, 57）
- 卡门：哈维奥克供应店（67, 46）
- 塔玛拉：塔玛拉和卡门的家（51, 73）
```

**地理距离太远，感知范围（10格）无法覆盖！**

## 解决方案

### 方案A：修改日程，增加公共活动区域 ⭐ 推荐

**目标**：让agents更频繁地到咖啡馆等公共场所

**实施步骤**：

1. 修改agents的初始日程，增加"去咖啡馆"的活动频率
2. 减少独自工作的时间
3. 增加社交/聚会活动

**优点**：
- 更真实的社交行为
- agents自主决定何时对话
- 符合实验设计初衷

**缺点**：
- 需要手动修改4个agent的配置文件

### 方案B：扩大感知范围 

**修改 `data/config.json`**：

```json
{
  "percept": {
    "vision_r": 20,     // 从10改为20，扩大一倍
    "att_bandwidth": 15  // 从10改为15
  }
}
```

**优点**：
- 简单，只改一个配置
- 立即生效

**缺点**：
- agents能"看到"很远的人（不太真实）
- 治标不治本

### 方案C：缩小地图或调整出生点

**目标**：让4个agents的工作地点更靠近

**实施方式**：
- 修改 `assets/village/agents/*/agent.json` 中的初始位置
- 或者使用更小的地图

**优点**：
- 从根本上增加相遇概率

**缺点**：
- 需要修改多个配置文件
- 可能破坏原有的小镇设计

### 方案D：强制安排集体活动 ⭐⭐ 最简单有效

**修改 `start.py` 添加自定义日程**：

在agents初始化后，给每个agent添加"咖啡馆社交时间"：

```python
# 在start.py中，创建game后添加：
for agent in game.agents.values():
    # 每2小时去一次咖啡馆，停留30分钟
    # 这会触发更多对话
    pass  # 需要实现日程插入逻辑
```

**优点**：
- 保证agents定期相遇
- 不破坏原有配置

**缺点**：
- 需要编写日程管理代码

### 方案E：降低stride，增加模拟密度 ✅ 立即可用

**当前命令**：
```bash
python start.py --name town-test --step 20 --stride 10
```

**优化命令**：
```bash
python start.py --name town-test-dense --step 50 --stride 5
```

**效果**：
- 更密集的时间采样
- 从每10分钟一步改为每5分钟一步
- 运行50步 = 4小时10分钟
- 相遇机会翻倍

**优点**：
- **无需修改任何代码**
- 立即可用

**缺点**：
- 运行时间翻倍（但相遇概率也翻倍）

## 快速测试方案 🚀

### 组合拳：方案B + 方案E

**步骤1**：修改配置扩大感知范围

```bash
# 备份原配置
cp data/config.json data/config.json.bak

# 编辑 data/config.json
# 将 vision_r 改为 20
# 将 att_bandwidth 改为 15
```

**步骤2**：使用更密集的步长运行

```bash
python start.py --name high-freq-test --step 50 --stride 5 --verbose info
```

**预期效果**：
- 运行4小时模拟时间
- stride=5分钟，更密集采样
- vision_r=20，感知范围翻倍
- **预计产生10-20次对话** ✅

**验证**：
```bash
python -c "import json; data = json.load(open('results/checkpoints/high-freq-test/conversation.json', encoding='utf-8')); print(f'对话总数：{sum(len(v) for v in data.values())}次'); [print(f'{k}: {len(v)}次') for k,v in data.items()]"
```

## 终极方案：修改Agent日程 💪

如果上述方案效果仍不理想，需要修改agents的日程安排，让他们定期聚集。

### 需要修改的文件：

```
assets/village/agents/伊莎贝拉/agent.json
assets/village/agents/玛丽亚/agent.json
assets/village/agents/卡门/agent.json
assets/village/agents/塔玛拉/agent.json
```

### 修改示例（以玛丽亚为例）：

在她的初始记忆中添加：
```json
{
  "memory": [
    "玛丽亚每天上午10点会去霍布斯咖啡馆学习2小时",
    "玛丽亚每天下午3点会去霍布斯咖啡馆休息1小时",
    "玛丽亚喜欢在咖啡馆和朋友交流"
  ]
}
```

这样agents会自主安排去咖啡馆的行程。

## 建议执行顺序

1. ✅ **立即测试**：方案E（改stride=5）
   ```bash
   python start.py --name dense-test --step 50 --stride 5
   ```

2. ✅ **如果效果不佳**：加上方案B（扩大vision_r到20）
   ```bash
   # 修改 data/config.json 中的 vision_r: 20
   python start.py --name wide-vision-test --step 50 --stride 5
   ```

3. ⚠️ **如果还是太少**：修改agents配置，增加咖啡馆活动（方案A）

4. 🔧 **最后手段**：使用 `party_chat.py` 强制对话模式
   ```bash
   python party_chat.py --name forced-chat --rounds 100
   ```

## 预期对话频率目标

| 模拟时长 | 最少对话次数 | 理想对话次数 |
|---------|------------|------------|
| 1小时 | 3次 | 5-8次 |
| 3小时 | 10次 | 15-25次 |
| 5小时 | 20次 | 30-50次 |

当前状况（20步=3.17小时）：**2次** ❌
目标：**至少10次** ✅
