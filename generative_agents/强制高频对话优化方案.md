# 强制高频对话优化方案 🚀

## 🎯 问题分析

**原始问题**：即使降低了对话间隔（60分钟→15分钟→5分钟）并扩大了感知范围（10格→20格→30格），agents仍然很少对话（3小时只有1-2次）。

**根本原因**：
1. **动机不足**：agents的人设中没有强烈的社交动机
2. **地理分散**：各自在不同地点工作，很少相遇
3. **决策保守**：`decide_chat` 提示词过于保守，agents倾向于不打扰别人

---

## ✅ 已实施的强制性优化

### 1. 人设全面改造 ⭐⭐⭐ 核心优化

**改造内容**：将4个agents全部改造为**Novlang语言实验项目参与者**

#### 伊莎贝拉（咖啡馆老板）→ **实验主持人**
- **新身份**：语言涌现实验项目主持人
- **新动机**：每天主动召集大家交流，观察语言演化
- **新行为**：每1-2小时主动找人聊天，每天至少8-10次对话
- **固定时间**：上午10点、中午12点、下午3点、晚上6点组织讨论

#### 玛丽亚（学生）→ **热心学习者**
- **新身份**：Novlang实验的热心参与者
- **新动机**：认为多交流能帮助掌握Novlang，经常主动去咖啡馆
- **新行为**：每天上午、下午、晚上各去咖啡馆2-3次
- **停留时间**：每次30分钟-1小时

#### 卡门（供应店主人）→ **积极参与者**
- **新身份**：Novlang实验参与者，认为多交流能提高语言能力
- **新动机**：在工作间隙频繁去咖啡馆社交
- **新行为**：10点、12点、下午3点、5点都会去咖啡馆
- **停留时间**：每次20-30分钟

#### 塔玛拉（作家）→ **观察者和记录者**
- **新身份**：把语言实验作为创作灵感来源
- **新动机**：频繁对话能激发创意，也能让大家更好地掌握Novlang
- **新行为**：每隔一段时间就去咖啡馆（9点、11点、1点、3点、5点、7点）
- **停留时间**：每次20-40分钟，把咖啡馆当第二工作室

---

### 2. 对话决策提示词优化 ⭐⭐

**修改文件**：`data/prompts/decide_chat.txt`

**新增内容**：
```
【重要说明】
${agent} 和 ${another} 正在参与Novlang语言实验项目，他们需要频繁用符号语言交流来提高语言能力。
项目要求他们每天进行多次对话练习，即使是简单的问候或短暂交流也很有价值。
只要有机会相遇，就应该主动交流。
```

**效果**：
- LLM会理解agents有明确的对话任务
- 降低对话门槛，简单交流也算有价值
- 引导LLM更倾向于回答"是"

---

### 3. 参数配置（已完成）⭐

这些参数在之前已经优化：

```json
{
  "对话间隔": "5分钟（原60分钟，12倍提升）",
  "感知范围": "30格（原10格，9倍面积）",
  "注意力带宽": "20个对象（原10个，2倍提升）",
  "思考速度": "500ms（原1000ms，2倍提升）",
  "对话深度": "10轮（原4轮，2.5倍提升）",
  "记忆容量": "12条（原8条，50%提升）"
}
```

**代码修改**：`modules/agent.py` 第547行
```python
if delta < 5:  # 5分钟内不重复对话
    return False
```

---

## 📊 预期效果对比

| 维度 | 优化前 | 优化后 | 提升倍数 |
|-----|--------|--------|---------|
| **对话动机** | 无明确动机 | 实验任务驱动 | ∞ |
| **相遇频率** | 偶然相遇 | 固定时间聚集 | 10x+ |
| **对话意愿** | 保守，避免打扰 | 积极，主动交流 | 5x+ |
| **对话间隔** | 60分钟 | 5分钟 | 12x |
| **感知范围** | 10格（314格²） | 30格（2827格²） | 9x |
| **3小时对话数** | 1-2次 ❌ | **30-50次** ✅ | **30x+** |

---

## 🚀 立即开始新实验

### 步骤1：清理旧实验（可选）

```bash
# 如果想从头开始
rm -r results\checkpoints\high-freq-test\
```

### 步骤2：启动超高频实验

```bash
cd C:\Users\admin\Desktop\GenerativeAgentsCN-main\generative_agents
conda activate generative_agents_cn

# 使用新配置启动实验
python start.py --name social-freq-test --step 40 --stride 3 --verbose info
```

**参数说明**：
- `--name social-freq-test`：新实验名称（区分之前的实验）
- `--step 40`：运行40步
- `--stride 3`：每3分钟一步（2小时总时长）
- `--verbose info`：显示详细日志

### 步骤3：实时监控对话

**在另一个终端运行**：
```bash
# 每30秒检查一次对话数
while ($true) {
    $count = (python -c "import json; data = json.load(open('results/checkpoints/social-freq-test/conversation.json', encoding='utf-8')); print(sum(len(v) for v in data.values()))" 2>$null)
    if ($count) {
        Write-Host "$(Get-Date -Format 'HH:mm:ss') - 当前对话数: $count 次" -ForegroundColor Green
    }
    Start-Sleep -Seconds 30
}
```

### 步骤4：完成后分析

```bash
# 查看对话总数和分布
python -c "import json; data = json.load(open('results/checkpoints/social-freq-test/conversation.json', encoding='utf-8')); print(f'\n✅ 总对话数：{sum(len(v) for v in data.values())}次\n'); print('时间分布：'); [print(f'  {k}: {len(v)}次') for k,v in sorted(data.items())]"

# 使用分析工具
python analyze_emergence.py results/checkpoints/social-freq-test/conversation.json
```

---

## 🎯 核心改进逻辑

### 改进1：从"偶然相遇"到"定时集会"

**优化前**：
```
伊莎贝拉在咖啡馆 (74, 23)
玛丽亚在宿舍 (123, 57)  ← 距离太远
卡门在供应店 (67, 46)
塔玛拉在家 (51, 73)
```
→ 几乎不会相遇

**优化后**：
```
时间点：上午10点
伊莎贝拉：在咖啡馆等待 ✓
玛丽亚：去咖啡馆 ✓
卡门：去咖啡馆 ✓
塔玛拉：去咖啡馆 ✓
```
→ 保证相遇！

### 改进2：从"无动机"到"任务驱动"

**优化前**：
```python
LLM判断：
"伊莎贝拉在工作，玛丽亚在学习，打扰对方不太好"
→ 回答"否"
```

**优化后**：
```python
LLM判断：
"伊莎贝拉和玛丽亚都是Novlang实验参与者"
"项目要求频繁对话练习"
"现在相遇是进行对话的好机会"
→ 回答"是" ✓
```

### 改进3：从"被动等待"到"主动寻找"

**优化前**：
- daily_plan: "在咖啡馆工作"（被动）
- 等别人来找自己

**优化后**：
- daily_plan: "每隔1-2小时去咖啡馆主动找人交流"（主动）
- 明确的时间节点（10点、12点、3点、6点...）
- 固定的停留时间（20-40分钟）

---

## ⚙️ 技术实现细节

### 修改的文件清单

1. **角色配置文件**（4个）
   - `frontend/static/assets/village/agents/伊莎贝拉/agent.json`
   - `frontend/static/assets/village/agents/玛丽亚/agent.json`
   - `frontend/static/assets/village/agents/卡门/agent.json`
   - `frontend/static/assets/village/agents/塔玛拉/agent.json`

2. **对话决策提示词**
   - `data/prompts/decide_chat.txt`

3. **系统配置**（之前已修改）
   - `data/config.json`：感知范围和参数
   - `modules/agent.py`：对话间隔限制

### 关键代码逻辑

**对话触发条件**（`modules/agent.py`）：
```python
def _chat_with(self, other, focus):
    # 1. 检查是否在同一地点或感知范围内
    if not self._is_nearby(other):
        return False
    
    # 2. 检查对话间隔（5分钟限制）
    if delta < 5:
        return False
    
    # 3. LLM决策是否对话（现在更容易返回"是"）
    if not self.completion("decide_chat", ...):
        return False
    
    # 4. 开始对话！
    self.start_conversation(other)
```

---

## 📈 成功指标

### 基准目标
- **2小时实验**：至少20次对话
- **平均频率**：每6分钟1次
- **参与度**：每个agent至少参与10次对话

### 优秀目标
- **2小时实验**：30-50次对话
- **平均频率**：每3-4分钟1次
- **参与度**：每个agent参与15-20次对话

### 理想状态
在咖啡馆聚集时段（如10:00-10:30），应该出现：
- 伊莎贝拉 ↔ 玛丽亚：2-3次
- 伊莎贝拉 ↔ 卡门：2-3次
- 玛丽亚 ↔ 卡门：2-3次
- 塔玛拉参与多个对话
- **30分钟内产生6-10次对话** ✨

---

## 🔧 进一步优化选项

如果对话数仍然不够，可以：

### 选项1：缩短对话间隔到3分钟
```python
# modules/agent.py 第547行
if delta < 3:  # 改为3分钟
    return False
```

### 选项2：修改daily_plan为更密集的时间表
在agent.json中添加更详细的hourly_plan，强制每小时去咖啡馆

### 选项3：直接修改decide_chat为"是"
```python
# modules/prompt/scratch.py
# 找到 decide_chat 方法，强制返回 True
def prompt_decide_chat(...):
    return True  # 强制总是对话
```

### 选项4：使用party_chat.py强制轮流
```bash
python party_chat.py --name forced-100 --rounds 100
```
这会产生100轮保证的对话，无视地理位置

---

## 📝 注意事项

### 1. 配置持久性
修改 agent.json 后，**新实验**会使用新配置，但**旧实验**（如使用--resume）会保留原配置。

建议：**用新名字启动实验**
```bash
python start.py --name social-freq-test --step 40 --stride 3
```

### 2. 观察agents行为
可以查看simulate-*.json文件中agents的coord和action：
```bash
# 查看10:00时刻agents的位置
python -c "import json; data = json.load(open('results/checkpoints/social-freq-test/simulate-20240213-1000.json', encoding='utf-8')); [print(f\"{a['name']} @ {a['action']['event']['address']}\") for a in data['agents'].values()]"
```

### 3. Ollama稳定性
高频对话会大量调用LLM，确保：
- Ollama服务稳定运行
- 电脑性能足够
- 网络连接良好

---

## 🎉 预期成果

使用新配置后，你应该能看到：

1. **对话爆发**：在固定时间点（10点、12点等）出现对话高峰
2. **自然交流**：agents用Novlang进行短暂但频繁的交流
3. **语言演化**：通过多次对话，符号使用模式逐渐稳定
4. **真实社交**：agents像真正的实验参与者一样积极交流

**从1-2次/3小时 → 30-50次/2小时** = **30倍+提升！** 🚀

---

## 快速启动命令

```bash
# 一键启动超高频社交实验
cd C:\Users\admin\Desktop\GenerativeAgentsCN-main\generative_agents
conda activate generative_agents_cn
python start.py --name social-freq-test --step 40 --stride 3 --verbose info
```

祝实验成功！🎊
